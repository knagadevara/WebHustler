user  nginx;
group nginx;
## Ideally set to number of CPU's best value is for ngnix to decide with auto instead of a hard value as [1,2,3 .. N]
worker_processes  auto;
## To avoid the too many openfiles error on high traffic systems
worker_rlimit_nofile 15000;
## Set a custom pid
pid        /run/nginx.pid;
## A connection processing method is automatically picked but it can be manyally done by 'use'
use epoll; ## https://nginx.org/en/docs/events.html#epoll
 

events {
    ## number of connections simultaniously allowed to access
    worker_connections  2048;
    ## Allows nginx to accept multiple connections
    multi_accept on;
}

http {

    ## Enabling HTTP2
    http2 on;

    ## Accepting all available and compatible mime types provided by nginx
    include mime.types;
    ## Enabling fastcgi for php based content
    include fastcgi.conf;

    # Security
    ## Switching off the bascic server information detail.
    server_tokens off;
    server_name_hash_bucket_size  64K;
    ## Not letting the requests forwaded to different base domains
    add_header X-Frame-Options "SAMEORIGIN";
    ## Disabling and blocking cross site scripting.
    add_header X-XSS-Protection "1; mode=block";

    ## Setting Rate limiting
    limit_req_zone $request_uri zone=NgRPS:64m rate=2r/s;
    
    ## Cache Setting
    fastcgi_cache_path /tmp/nginx_db_cache inactive=60m levels=1:2 keys_zone=BLBX_1:1000m use_temp_path=on;
    # fastcgi_cache_path /tmp/nginx_static_cache inactive=60m levels=1:2 keys_zone=STZN_1:1000m use_temp_path=on;
    fastcgi_cache_key "$request_method$request_uri$args";
    fastcgi_cache_valid 200 30m;
    fastcgi_cache_valid 400 401 403 404 10m;

    ## Enabling gzip to compress compatible files
    gzip on;
    gzip_types "*";
    gzip_comp_level 4;

    ## Sending 40X, 50X to default error pages
    error_page  404              /404.html;
    error_page  500 502 503 504  /50x.html;

    # Buffer Size Tuning
    ## Increasing the size of default buffer size to minimize nginx from rd, wt ops from disk to buffer.
    client_body_buffer_size 16K; ## Called on POST actions
    ## Max acceptable body size while POST/PUT Uploads.
    client_max_body_size 8M;
    ## Client Header size
    client_header_buffer_size 2K;
    large_client_header_buffer 2 2K;

    # Server TimeOut
    ## Server wait the specified time for client to respomd.
    client_body_timeout 2m;
    client_header_timeout 2m;
    ## Server will close Connections.
    keepalive_time 20m;
    keepalive_timeout 120s;
    send_timeout 10;

    ## Not coping static files to buffer, rather directly sending them
    sendfile on;
    tcp_nopush on;

    ## SSL Certificate Path
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers CDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256;
    ssl_session_cache shared:TLSV3:64m;
    ssl_session_timeout 4h;
    ssl_session_tickets on;

    ssl_dhparam /srv/nginx/ssl/dhparam.pem;
    ssl_certificate /srv/nginx/ssl/nginx.crt;
    ssl_certificate_key /srv/nginx/ssl/nginx.key;

    include sites/boxmen.com;
    include sites/bluebix.com;

    ## Creating two cache staches
    add_header Cache-Control public;
    add_header Pragma public;
    add_header Vary Accept-Encoding;
    add_header X-Cache $upstream_cache_status;
    add_header Strict-Transport-Security "max-age=31536000" always;
}
